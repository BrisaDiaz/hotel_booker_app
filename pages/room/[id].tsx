import type { NextPage, GetServerSideProps, NextApiResponse } from 'next';
import React from 'react';
import { client } from '@/lib/apollo';
import Head from 'next/head';
import Box from '@mui/material/Box';
import DoneIcon from '@mui/icons-material/Done';
import Typography from '@mui/material/Typography';
import TodayIcon from '@mui/icons-material/Today';
import Button from '@mui/material/Button';
import ImageListItem from '@mui/material/ImageListItem';
import ImageList from '@mui/material/ImageList';
import { useTheme } from '@mui/material/styles';
import RoomPreferencesIcon from '@mui/icons-material/RoomPreferences';
import BedIcon from '@mui/icons-material/Bed';
import RoomServiceIcon from '@mui/icons-material/RoomService';
import Modal from '@/components/AbailableRoomModal';
import RoomBedsUI from '@/components/RoomBedsUI';
import DinamicFieldIcone from '@/components/DinamicFieldIcone';
import PersonOutlineIcon from '@mui/icons-material/PersonOutline';
import StraightenIcon from '@mui/icons-material/Straighten';
import { RoomModel, Item } from '@/interfaces/index';
import { useRouter } from 'next/router';
import { useMutation } from '@apollo/client';
import { MAKE_ROOM_CONSULT, GET_ROOM_MODEL_BY_ID } from '@/queries/index';
const styles = {
  list: {
    display: 'flex',
    p: '0 10px',
    flexWrap: 'wrap',
    gap: '20px',
    fontWeight: 400,
  },
  listItem: {
    display: 'flex',
    gap: '10px',
    textTransform: 'capitalize',
    alignItems: 'center',
    '& p': {
      m: '8px 0',
    },
  },
  featuresItems: {
    display: 'flex',
    gap: '10px',
    textTransform: 'capitalize',
    alignItems: 'center',
    width: { xs: '250px', sm: '300px' },
  },
};
const RoomPage: NextPage = ({ room }: { room: RoomModel }) => {
  const router = useRouter();
  const theme = useTheme();
  const handleRedirectToHotel = (id: number) => {
    router.push(`/hotel/${id}`);
  };
  const [makeRoomConsult, { data, loading, error }] =
    useMutation(MAKE_ROOM_CONSULT);
  type Room = {
    childrens: number;
    adults: number;
  };
  type Data = {
    checkInDate: string;
    checkOutDate: string;
    rooms: Room[];
  };
  const handleConsutlSubmit = async (data: Data) => {
    console.log(data);
    try {
      await makeRoomConsult({ variables: { ...data, roomModelId: room.id } });
    } catch (err) {
      console.log(err);
      console.log(error?.graphQLErrors);
    }
  };
  React.useEffect(() => {
    if (!loading && data?.message) {
      console.log(data);
    }
  }, [loading]);
  return (
    <div>
      <Head>
        <title>Hotel</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Box component="main" sx={{ maxWidth: '1000px', m: '20px auto 30px' }}>
        <Typography
          variant="h3"
          component="h1"
          onClick={() => handleRedirectToHotel(room.hotelId)}
          sx={{
            fontWeight: 700,
            margin: { xs: '0 10px', md: 0 },
            width: 'fit-content',
            textTransform: 'capitalize',

            cursor: 'pointer',
            '&:hover': {
              color: 'rgb(0 0 0 / 70%)',
              textDecoration: 'underline',
              textUnderlineOffset: '5px',
            },
          }}
        >
          {room.hotel.name}
        </Typography>
        <Typography
          variant="h4"
          component="h2"
          color="primary"
          sx={{
            fontWeight: 700,
            margin: { xs: '0 10px', md: 0 },
            width: 'fit-content',
            textTransform: 'capitalize',
            padding: '10px 0 5px',
          }}
        >
          {room.name}
        </Typography>

        <ImageList
          sx={{
            width: '100%',
            maxHeight: '500px',
            overflow: 'hidden',
            objectFit: 'cover',
            objectPosition: 'center bottom',
          }}
          rowHeight={500}
          cols={1}
        >
          <ImageListItem cols={1}>
            <img
              src={`${room.mainImage}?w=248&fit=crop&auto=format`}
              srcSet={`${room.mainImage}?w=248&fit=crop&auto=format&dpr=2 2x`}
              alt={`${room.hotel.name} ${room.category}`}
              loading="lazy"
            />
          </ImageListItem>
        </ImageList>
        <Typography
          component="h4"
          variant="h5"
          sx={{
            p: '10px',
            fontWeight: 200,
            maxWidth: 'fit-content',
            m: '0 15px 0 auto',
          }}
        >
          From{' '}
          <Typography
            variant="h5"
            component="span"
            sx={{ color: 'primary.main', fontWeight: 700, ml: 1 }}
          >
            USD${room.lowestPrice}
          </Typography>
          /Night
        </Typography>
        <Typography
          variant="subtitle1"
          color="primary"
          sx={{
            p: '0 10px ',
            fontWeight: 200,
            width: 200,
            textAlign: 'end',
            m: '0 15px 30px auto',
          }}
        >
          Taxes and Charges{' '}
          <Typography component="span" sx={{ fontWeight: 200, ml: 0.5 }}>
            USD${room.taxesAndCharges}
          </Typography>
        </Typography>
        <Box
          component="ul"
          sx={{
            display: 'flex',
            gap: 3,
            flexWrap: 'wrap',
            alignItems: 'center',
            mx: '10px',
            p: 0,
          }}
        >
          {room.freeCancelation && (
            <Box sx={styles.listItem} component="li">
              {DinamicFieldIcone('free cancelation')}
              <Typography>free cancelation</Typography>
            </Box>
          )}
          {room.smooking && (
            <Box sx={styles.listItem} component="li">
              {DinamicFieldIcone('smoker friendly')}
              <Typography>smoker friendly</Typography>
            </Box>
          )}
        </Box>
        <Typography
          component="pre"
          sx={{ margin: ' 10px 10px 20px ', whiteSpace: 'pre-line' }}
        >
          {room.description}
        </Typography>

        <Modal onSubmit={handleConsutlSubmit}>
          <Button
            sx={{ padding: '10px 20px', m: '10px' }}
            color="secondary"
            variant="contained"
          >
            Check Diponibility
          </Button>
        </Modal>
        <Box
          sx={{
            m: '20px 10px 30px',
          }}
        >
          <Box
            sx={{
              display: 'flex',
              gap: '10px',

              alignItems: 'center',
              my: 3,
            }}
          >
            <BedIcon color="primary" />

            <Typography
              variant="h6"
              sx={{
                fontWeight: 300,
                textTransform: 'capitalize',
              }}
            >
              Capacity
            </Typography>
          </Box>
          <Box
            component="ul"
            sx={{
              display: 'flex',
              alignItems: 'center',
              rowGap: 3,
              textTransform: 'capitalize',
              margin: ' 0 15px',
              flexWrap: 'wrap',
              p: 0,
            }}
          >
            <Box
              component="li"
              sx={{
                width: '300px',
                display: 'flex',
              }}
            >
              <StraightenIcon color="secondary" sx={{ mr: 2 }} />
              <Typography
                sx={{
                  width: 'max-content',

                  marginRight: '5px',
                  fontWeight: 400,
                }}
              >
                {room.mts2} Mts <sup>2</sup>
              </Typography>
            </Box>
            <Box
              component="li"
              sx={{
                width: '300px',
                display: 'flex',
              }}
            >
              {room.beds && room.beds.length && RoomBedsUI(room.beds, 'medium')}
            </Box>
            <Box
              component="li"
              sx={{
                width: '300px',
                display: 'flex',
              }}
            >
              {new Array(room.maximunGuests).fill(1).map((_, index) => (
                <PersonOutlineIcon color="secondary" key={index} />
              ))}
              <Typography sx={{ mx: 2 }}>
                {room.maximunGuests}
                {room.maximunGuests > 1 ? ' people ' : ' persone '} max
              </Typography>
            </Box>
          </Box>
          <Box
            sx={{
              margin: '30px 0',
            }}
          >
            <Box
              sx={{
                display: 'flex',
                gap: '10px',
                alignItems: 'center',
                my: 3,
              }}
            >
              <RoomPreferencesIcon color="primary" />

              <Typography
                variant="h6"
                sx={{
                  fontWeight: 300,
                  textTransform: 'capitalize',
                }}
              >
                Amenities
              </Typography>
            </Box>
            {room.amenities && room?.amenities?.length && (
              <Box sx={styles.list} component="ul">
                {room.amenities.map((item: Item) => (
                  <Box key={item.id} sx={styles.featuresItems} component="li">
                    <DoneIcon
                      fontSize="small"
                      sx={{ color: theme.palette.secondary.main }}
                    />
                    <Typography>{item.name}</Typography>
                  </Box>
                ))}
              </Box>
            )}
            <Box
              sx={{
                display: 'flex',
                gap: '10px',
                alignItems: 'center',
                my: 3,
              }}
            >
              <RoomServiceIcon color="primary" />

              <Typography
                variant="h6"
                sx={{
                  fontWeight: 300,
                  textTransform: 'capitalize',
                }}
              >
                Services
              </Typography>
            </Box>
            {room.services && room?.services?.length && (
              <Box sx={styles.list} component="ul">
                {room.services.map((item: Item) => (
                  <Box key={item.id} sx={styles.featuresItems} component="li">
                    <DoneIcon
                      fontSize="small"
                      sx={{ color: theme.palette.secondary.main }}
                    />
                    <Typography>{item.name}</Typography>
                  </Box>
                ))}
              </Box>
            )}
          </Box>
        </Box>
      </Box>
    </div>
  );
};

export default RoomPage;
export const getServerSideProps: GetServerSideProps = async ({
  query,
  res,
}: {
  query: { id: number };
  res: NextApiResponse;
}) => {
  const { data, error, loading } = await client.query({
    query: GET_ROOM_MODEL_BY_ID,
    variables: { id: query.id },
  });

  if (error) {
    return {
      redirect: {
        permanent: false,
        destination: '/search',
      },
      props: {},
    };
  }

  return {
    props: {
      room: data?.roomModelById,
    },
  };
};
